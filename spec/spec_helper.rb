# frozen_string_literal: true

# #SignWell Developer API
#
# No description provided (generated by Openapi Generator https://github.com/openapitools/openapi-generator)
#
# The version of the OpenAPI document: v1
# Contact: support@signwell.com
# Generated by: https://openapi-generator.tech
# Generator version: 7.12.0
#

require 'signwell_sdk'

RSpec.configure do |config|
  config.expect_with :rspec do |expectations|
    expectations.include_chain_clauses_in_custom_matcher_descriptions = true
  end

  config.mock_with :rspec do |mocks|
    mocks.verify_partial_doubles = true
  end

  # Tag :prism tests so they can be run separately
  config.define_derived_metadata(file_path: %r{/spec/api/}) do |metadata|
    metadata[:prism] = true
  end

  # Skip Prism tests unless mock server is reachable
  config.before(:each, :prism) do
    unless ENV['PRISM_URL'] || prism_available?
      skip 'Prism mock server not running (start with: npx @stoplight/prism-cli mock openapi.yaml -p 4010)'
    end
  end

  config.order = :random
  Kernel.srand config.seed
end

def prism_available?
  return @prism_available if defined?(@prism_available)

  require 'net/http'
  uri = URI(ENV.fetch('PRISM_URL', 'http://localhost:4010'))
  @prism_available = begin
    Net::HTTP.start(uri.host, uri.port, open_timeout: 1, read_timeout: 1) { true }
  rescue Errno::ECONNREFUSED, Errno::EHOSTUNREACH, Net::OpenTimeout
    false
  end
end
